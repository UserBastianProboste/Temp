<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Brevo Email Service</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .email-list {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .email-list strong {
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de Brevo Email Service</h1>
        
        <div class="email-list">
            <strong>üìß Configuraci√≥n:</strong>
            <ul>
                <li><strong>Remitente:</strong> consultoriapracticas@gmail.com ‚úÖ</li>
                <li><strong>Destinatarios de prueba:</strong>
                    <ul>
                        <li>niconicotu@gmail.com</li>
                        <li>nicolas.salinas1@cloud.uautonoma.cl</li>
                    </ul>
                </li>
            </ul>
            <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <strong>‚úÖ FROM_EMAIL actualizado correctamente</strong>
                <p style="margin: 5px 0; font-size: 14px;">
                    Remitente: <strong>consultoriapracticas@gmail.com</strong> (verificado en Brevo)
                </p>
            </div>
        </div>

        <button onclick="testBasicEmail()" id="btnBasic">
            üì® Test Email B√°sico
        </button>

        <button onclick="testFullEmail()" id="btnFull">
            üìã Test Email Completo (Pr√°ctica)
        </button>

        <button onclick="testMultipleRecipients()" id="btnMultiple">
            üë• Test M√∫ltiples Destinatarios
        </button>

        <button onclick="clearResults()" id="btnClear">
            üóëÔ∏è Limpiar Resultados
        </button>

        <div id="result" class="result"></div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://rrfygzljzxwdckksskqq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZnlnemxqenh3ZGNra3Nza3FxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NzMzNDksImV4cCI6MjA3NDI0OTM0OX0.vJZrqcLY5qr88P1eOBw2WVOHkapgy0oYl5fWoTtXeSc';

        const EMAIL_1 = 'niconicotu@gmail.com';
        const EMAIL_2 = 'nicolas.salinas1@cloud.uautonoma.cl';

        async function sendBrevoEmail(payload) {
            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email-brevo`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'apikey': SUPABASE_ANON_KEY,
                },
                body: JSON.stringify(payload)
            });

            const text = await response.text();
            let json = null;
            try {
                json = JSON.parse(text);
            } catch (e) {
                json = { raw: text };
            }

            if (!response.ok) {
                throw new Error(JSON.stringify(json, null, 2));
            }

            return json;
        }

        function showResult(type, message, details = null) {
            const result = document.getElementById('result');
            result.className = `result ${type}`;
            result.style.display = 'block';
            
            let html = `<strong>${message}</strong>`;
            if (details) {
                html += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
            result.innerHTML = html;
        }

        function setLoading(buttonId, loading) {
            const btn = document.getElementById(buttonId);
            if (loading) {
                btn.disabled = true;
                btn.innerHTML += '<span class="loading"></span>';
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.innerHTML.replace('<span class="loading"></span>', '');
            }
        }

        window.testBasicEmail = async function() {
            try {
                setLoading('btnBasic', true);
                showResult('info', '‚è≥ Enviando email b√°sico a niconicotu@gmail.com...');

                const result = await sendBrevoEmail({
                    to: EMAIL_1,
                    subject: 'üß™ Test B√°sico - Sistema de Pr√°cticas',
                    mensaje_html: `
                        <h1>‚úÖ Test de Email B√°sico</h1>
                        <p>Este es un email de prueba del sistema de pr√°cticas profesionales.</p>
                        <p><strong>Fecha:</strong> ${new Date().toLocaleString('es-CL')}</p>
                        <p><strong>Destinatario:</strong> ${EMAIL_1}</p>
                        <hr>
                        <p>Si recibes este email, el sistema est√° funcionando correctamente.</p>
                        <p style="color: #4CAF50; font-weight: bold;">üéâ ¬°Sistema operativo!</p>
                    `
                });

                showResult('success', '‚úÖ Email b√°sico enviado exitosamente!', result);
            } catch (error) {
                showResult('error', '‚ùå Error al enviar email b√°sico', error.message);
            } finally {
                setLoading('btnBasic', false);
            }
        };

        window.testFullEmail = async function() {
            try {
                setLoading('btnFull', true);
                showResult('info', '‚è≥ Enviando email completo a nicolas.salinas1@cloud.uautonoma.cl...');

                const result = await sendBrevoEmail({
                    to: EMAIL_2,
                    subject: 'üéì Sistema de Pr√°cticas - Universidad Aut√≥noma de Chile',
                    coordinator_name: 'Coordinaci√≥n de Pr√°cticas',
                    estudiante_nombre: 'Nicol√°s',
                    estudiante_apellido: 'Salinas',
                    tipo_practica: 'Pr√°ctica I',
                    practica_id: 'test-12345',
                    empresa: 'Empresa Demo S.A.',
                    fecha_inicio: '2025-01-15',
                    fecha_termino: '2025-06-30',
                    estado: 'aprobada',
                    mensaje_html: `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                        </head>
                        <body style="margin: 0; padding: 0; font-family: Arial, sans-serif;">
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f5f5f5; padding: 20px;">
                                <tr>
                                    <td align="center">
                                        <table width="600" cellpadding="0" cellspacing="0" style="background-color: white; border-radius: 8px; overflow: hidden;">
                                            <!-- Header -->
                                            <tr>
                                                <td style="background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%); padding: 30px; text-align: center;">
                                                    <h1 style="color: white; margin: 0; font-size: 28px;">Universidad Aut√≥noma de Chile</h1>
                                                    <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0 0;">Sistema de Pr√°cticas Profesionales</p>
                                                </td>
                                            </tr>
                                            
                                            <!-- Body -->
                                            <tr>
                                                <td style="padding: 40px 30px;">
                                                    <h2 style="color: #4CAF50; margin-top: 0;">üéâ ¬°Felicidades Nicol√°s Salinas!</h2>
                                                    <p style="font-size: 16px; line-height: 1.6; color: #333;">
                                                        Tu ficha de pr√°ctica profesional ha sido <strong style="color: #4CAF50;">APROBADA</strong>.
                                                    </p>
                                                    
                                                    <table width="100%" cellpadding="15" style="background-color: #f9f9f9; border-radius: 5px; margin: 20px 0;">
                                                        <tr>
                                                            <td>
                                                                <h3 style="margin: 0 0 15px 0; color: #333;">üìã Detalles de la Pr√°ctica</h3>
                                                                <table width="100%" cellpadding="5">
                                                                    <tr>
                                                                        <td style="color: #666;">üìö <strong>Tipo:</strong></td>
                                                                        <td style="color: #333;">Pr√°ctica I</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td style="color: #666;">üè¢ <strong>Empresa:</strong></td>
                                                                        <td style="color: #333;">Empresa Demo S.A.</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td style="color: #666;">üìÖ <strong>Periodo:</strong></td>
                                                                        <td style="color: #333;">15/01/2025 - 30/06/2025</td>
                                                                    </tr>
                                                                </table>
                                                            </td>
                                                        </tr>
                                                    </table>

                                                    <p style="font-size: 16px; line-height: 1.6; color: #333;">
                                                        Te deseamos mucho √©xito en esta nueva etapa profesional.
                                                    </p>
                                                </td>
                                            </tr>
                                            
                                            <!-- Footer -->
                                            <tr>
                                                <td style="background-color: #f5f5f5; padding: 30px; border-top: 1px solid #e0e0e0;">
                                                    <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">
                                                        Atentamente,<br>
                                                        <strong>Coordinaci√≥n de Pr√°cticas Profesionales</strong><br>
                                                        Universidad Aut√≥noma de Chile
                                                    </p>
                                                    <p style="margin: 15px 0 0 0; font-size: 12px; color: #999;">
                                                        Este es un correo autom√°tico del Sistema de Gesti√≥n de Pr√°cticas Profesionales.<br>
                                                        Para consultas, contacta a: practicas@uautonoma.cl
                                                    </p>
                                                    <p style="margin: 10px 0 0 0; font-size: 11px; color: #aaa;">
                                                        Universidad Aut√≥noma de Chile | Av. Pedro de Valdivia 425, Providencia, Santiago<br>
                                                        ¬© 2025 Universidad Aut√≥noma de Chile
                                                    </p>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </body>
                        </html>
                    `
                });

                showResult('success', '‚úÖ Email completo enviado exitosamente! Revisa la bandeja de entrada y SPAM en Outlook.', result);
            } catch (error) {
                showResult('error', '‚ùå Error al enviar email completo', error.message);
            } finally {
                setLoading('btnFull', false);
            }
        };

        window.testMultipleRecipients = async function() {
            try {
                setLoading('btnMultiple', true);
                showResult('info', '‚è≥ Enviando email a m√∫ltiples destinatarios...');

                const result = await sendBrevoEmail({
                    to: [EMAIL_1, EMAIL_2],
                    subject: 'üë• Test M√∫ltiples Destinatarios - Sistema de Pr√°cticas',
                    mensaje_html: `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                            <h2 style="color: #2196F3;">üë• Test de Env√≠o M√∫ltiple</h2>
                            <p>Este email fue enviado simult√°neamente a:</p>
                            <ul>
                                <li>‚úâÔ∏è niconicotu@gmail.com</li>
                                <li>‚úâÔ∏è nicolas.salinas1@cloud.uautonoma.cl</li>
                            </ul>
                            
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0;">
                                <p><strong>üìä Informaci√≥n del Test:</strong></p>
                                <ul>
                                    <li>Fecha: ${new Date().toLocaleString('es-CL')}</li>
                                    <li>Sistema: Pr√°cticas Profesionales</li>
                                    <li>Tipo: Env√≠o M√∫ltiple</li>
                                </ul>
                            </div>

                            <p>Si ambos destinatarios reciben este email, la funcionalidad de env√≠o m√∫ltiple est√° operativa.</p>
                        </div>
                    `
                });

                showResult('success', '‚úÖ Email enviado a m√∫ltiples destinatarios exitosamente!', result);
            } catch (error) {
                showResult('error', '‚ùå Error al enviar a m√∫ltiples destinatarios', error.message);
            } finally {
                setLoading('btnMultiple', false);
            }
        };

        window.clearResults = function() {
            const result = document.getElementById('result');
            result.style.display = 'none';
            result.innerHTML = '';
        };

        // Mostrar info inicial
        showResult('info', 'üöÄ Sistema listo para realizar pruebas. Haz clic en cualquier bot√≥n para comenzar.');
    </script>
</body>
</html>
